// ==UserScript==
// @name         巴哈姆特顯示全部最近閱覽
// @namespace    http://tampermonkey.net/
// @version      1.1(minified)
// @description  在原本位置增加全部最近閱覽
// @match        https://www.gamer.com.tw/*
// @match        https://forum.gamer.com.tw/
// @include      https://forum.gamer.com.tw/?c=*
// @icon         https://i2.bahamut.com.tw/favicon.svg?v=1689129528
// @grant        GM_xmlhttpRequest
// ==/UserScript==

(function(){"use strict";let e=window.location.href,t=function e(t){let a=document.cookie.split("; ").find(e=>e.startsWith(t+"="));return a?decodeURIComponent(a.split("=")[1]):null}("ckBH_lastBoard");if(!t)return console.warn("!ckBH_lastBoard");let a;try{a=JSON.parse(t)}catch(r){console.error(r);return}function n(t){return new Promise(a=>{GM_xmlhttpRequest({method:"GET",url:`https://forum.gamer.com.tw/A.php?bsn=${t}`,onload(t){try{let r=new DOMParser,n=r.parseFromString(t.responseText,"text/html");if(e.includes("www.gamer.com.tw")){let l=n.querySelector("div.FM-abox6B a img");l&&a(l.src)}let s=n.querySelector("div.FM-abox1.tippy-abox a img");a(s?s.src:"")}catch(i){a("")}},onerror(){a("")}})})}if(e.includes("www.gamer.com.tw")){function l(){let e=document.querySelector("#boardHistory");e&&(i&&i.disconnect(),console.log("DO"),e.innerHTML="",a.forEach(([t,a])=>{let r=document.createElement("li");r.className="sidenav-section__item";let l=document.createElement("a");l.className="sidenav-section__link link-item",l.href="https://forum.gamer.com.tw/B.php?bsn="+t,l.dataset.collapseTippy=a,l.dataset.gtmArea="最近閱覽",l.dataset.gtmLinkClick="點擊哈啦板",l.dataset.gtmPage="新首頁",l.dataset.gtmService="forum",l.dataset.gtmVar1=t;let s=document.createElement("div");s.className="sidenav-section__content";let i=document.createElement("img");i.className="sidenav-section__img",n(t).then(e=>{i.src=e}),i.loading="lazy";let o=document.createElement("p");o.className="sidenav-section__name",o.textContent=a,s.appendChild(i),s.appendChild(o),l.appendChild(s),r.appendChild(l),e.appendChild(r)}),i.observe(e,{childList:!0,subtree:!0}))}let s=document.querySelector("#boardHistory"),i=new MutationObserver(l);i.observe(s,{childList:!0,subtree:!0}),l()}else if(e.includes("forum.gamer.com.tw")){let o=document.querySelector(".relative.transition-all.Aside_section__QYARK.px-3"),c={childList:!0,subtree:!0};function d(){let e=o.querySelector('div[class=""]'),t=document.querySelector(".relative.transition-all.Aside_section__QYARK:not(.px-3)");if(!t)return;let r=t.querySelector('div[class=""]');e&&r&&(m&&m.disconnect(),e.innerHTML="",r.innerHTML="",a.forEach(([t,a])=>{let l=document.createElement("span"),s=document.createElement("a");s.href="https://forum.gamer.com.tw/B.php?bsn="+t,s.className="baha-duration-300 baha-ease-out baha-select-none baha-cursor-pointer baha-text-sm hover:baha-text-primary baha-text-secondary-text myBoard_boardItem__wyod_",s.tabIndex=-1;let i=document.createElement("img");i.className="myBoard_boardImage__Oa5K_ mr-2",i.alt=a,n(t).then(e=>{i.src=e}),i.loading="lazy";let o=document.createElement("span");o.className="line-clamp-2 leading-tight",o.innerHTML=a,s.append(i),s.append(o),l.append(s),e.append(l);let c=l.cloneNode(!0),d=c.querySelector("a"),m=d.querySelector("img");m.className="myBoard_boardImage__Oa5K_",n(t).then(e=>{m.src=e});let p=d.querySelector("span");p.className="line-clamp-2 leading-tight !hidden",r.append(c)}),m.observe(o,c))}let m=new MutationObserver(d);m.observe(o,c),d()}})();