// ==UserScript==
// @name         巴哈姆特顯示全部最近閱覽
// @namespace    巴哈姆特顯示全部最近閱覽-Johnson8033
// @version      1.3(minified)
// @author       Johnson8033
// @description  在原本位置增加全部最近閱覽
// @match        https://www.gamer.com.tw/*
// @match        https://forum.gamer.com.tw/*
// @icon         https://i2.bahamut.com.tw/favicon.svg?v=1689129528
// @grant        GM_registerMenuCommand
// @grant        GM_setValue
// @grant        GM_getValue
// @grant        GM_xmlhttpRequest
// @license      MIT
// @downloadURL  https://github.com/Johnson80331/Return-Bahamut-Recent-Pages/raw/refs/heads/main/%E5%B7%B4%E5%93%88%E5%A7%86%E7%89%B9%E9%A1%AF%E7%A4%BA%E5%85%A8%E9%83%A8%E6%9C%80%E8%BF%91%E9%96%B1%E8%A6%BD-(minified).user.js
// @updateURL    https://github.com/Johnson80331/Return-Bahamut-Recent-Pages/raw/refs/heads/main/%E5%B7%B4%E5%93%88%E5%A7%86%E7%89%B9%E9%A1%AF%E7%A4%BA%E5%85%A8%E9%83%A8%E6%9C%80%E8%BF%91%E9%96%B1%E8%A6%BD-(minified).user.js
// ==/UserScript==

(!async function(){"use strict";let e=window.location.href,t=GM_getValue("recentForums",[]);function a(e){let t=document.cookie.split("; ").find(t=>t.startsWith(e+"="));return t?decodeURIComponent(t.split("=")[1]):null}let r=a("ckTheme")?"dark":"light";GM_registerMenuCommand("更改顯示數量",function e(){if(document.getElementById("tm-integer-overlay"))return;let t=GM_getValue("recent",10),a={dark:{overlayBg:"rgba(0,0,0,0.7)",boxBg:"#1e1e1e",textColor:"#fff",inputBg:"#333",inputText:"#fff"},light:{overlayBg:"rgba(0,0,0,0.5)",boxBg:"#fff",textColor:"#000",inputBg:"#fff",inputText:"#000"}}[r],n=document.createElement("div");n.id="tm-integer-overlay",Object.assign(n.style,{position:"fixed",top:"0",left:"0",width:"100%",height:"100%",backgroundColor:a.overlayBg,display:"flex",justifyContent:"center",alignItems:"center",zIndex:"999999",fontFamily:'"Noto Sans TC", "Microsoft JhengHei", "PingFang TC", "Heiti TC", sans-serif'});let o=document.createElement("div");Object.assign(o.style,{backgroundColor:a.boxBg,padding:"20px",borderRadius:"10px",textAlign:"center",minWidth:"250px",boxShadow:"0 0 15px rgba(0,0,0,0.3)",color:a.textColor,display:"flex",flexDirection:"column",gap:"8px"});let i=document.createElement("div");i.textContent="輸入顯示數量(1-30):",i.style.marginBottom="10px";let l=document.createElement("input");l.type="number",l.min="1",l.max="30",l.value=t,l.style.width="100%",l.style.boxSizing="border-box",l.addEventListener("keypress",e=>{let t=String.fromCharCode(e.which);/[0-9]/.test(t)||e.preventDefault()}),l.addEventListener("paste",e=>{let t=(e.clipboardData||window.clipboardData).getData("text");/^\d+$/.test(t)||e.preventDefault()}),Object.assign(l.style,{width:"100%",padding:"8px",marginBottom:"10px",fontSize:"16px",borderRadius:"5px",border:"1px solid #ccc",backgroundColor:a.inputBg,color:a.inputText,outline:"none"});let s=document.createElement("button");s.textContent="確認",Object.assign(s.style,{padding:"8px 16px",fontSize:"16px",borderRadius:"5px",border:"none",backgroundColor:"#11aac1",color:"#fff",cursor:"pointer",alignSelf:"center"}),s.onmouseenter=()=>{s.style.backgroundColor="#117e96"},s.onmouseleave=()=>{s.style.backgroundColor="#11aac1"};let c=document.createElement("div");Object.assign(c.style,{color:"red",marginTop:"5px",fontSize:"14px",height:"18px",textAlign:"center"}),s.onclick=()=>{let e=parseInt(l.value,10);isNaN(e)||e<1||e>30?c.textContent="請輸入1-30的數字":(GM_setValue("recent",e),n.remove())},o.appendChild(i),o.appendChild(l),o.appendChild(s),o.appendChild(c),n.appendChild(o),document.body.appendChild(n)});let n=a("ckBH_lastBoard");if(!n)return console.warn("!ckBH_lastBoard");let o;try{o=JSON.parse(n)}catch(i){console.error(i);return}function l(e){return new Promise(t=>{GM_xmlhttpRequest({method:"GET",url:`https://forum.gamer.com.tw/A.php?bsn=${e}`,onload(e){try{let a=new DOMParser,r=a.parseFromString(e.responseText,"text/html"),n=r.querySelector("div.FM-abox6B a img");n&&t(n.src);let o=r.querySelector("div.FM-abox1.tippy-abox a img");t(o?o.src:"")}catch(i){t("")}},onerror(){t("")}})})}async function s(e,t){let a=GM_getValue("recentForums",[]),r={bsn:e,name:t};r.src=await l(e),(a=a.filter(t=>t.bsn!==e)).unshift(r),a.length>30&&(a=a.slice(0,30)),GM_setValue("recentForums",a)}async function c(e,a){(await Promise.all(o.map(async([e,t])=>{let a=await l(e);return{bsn:e,name:t,src:a}}))).forEach(e=>{(t=t.filter(t=>t.bsn!==e.bsn)).push(e)}),GM_setValue("recentForums",t)}if(0===t.length?await c():o&&!(e.startsWith("https://www.gamer.com.tw/")||"https://forum.gamer.com.tw/"===e||e.startsWith("https://forum.gamer.com.tw/?c="))&&await s(o[0][0],o[0][1]),!(o=GM_getValue("recentForums",[])))return console.warn("cookies list empty");let d=GM_getValue("recent",null);if(d||GM_setValue("recent",d=10),e.startsWith("https://www.gamer.com.tw/")){function p(){let e=document.querySelector("#boardHistory");if(!e)return console.warn("no boardHistory");for(let{bsn:t,name:a,src:r}of(u&&u.disconnect(),e.innerHTML="",o)){if(0==d--)break;let n=document.createElement("li");n.className="sidenav-section__item";let i=document.createElement("a");i.className="sidenav-section__link link-item",i.href="https://forum.gamer.com.tw/B.php?bsn="+t,i.dataset.collapseTippy=a,i.dataset.gtmArea="最近閱覽",i.dataset.gtmLinkClick="點擊哈啦板",i.dataset.gtmPage="新首頁",i.dataset.gtmService="forum",i.dataset.gtmVar1=t;let l=document.createElement("div");l.className="sidenav-section__content";let s=document.createElement("img");s.className="sidenav-section__img",s.src=r,s.loading="lazy";let c=document.createElement("p");c.className="sidenav-section__name",c.textContent=a,l.appendChild(s),l.appendChild(c),i.appendChild(l),n.appendChild(i),e.appendChild(n)}u.observe(e,{childList:!0,subtree:!0})}let m=document.querySelector("#boardHistory"),u=new MutationObserver(p);u.observe(m,{childList:!0,subtree:!0}),p()}else if("https://forum.gamer.com.tw/"===e||e.startsWith("https://forum.gamer.com.tw/?c=")){let g=document.querySelector(".relative.transition-all.Aside_section__QYARK.px-3");function h(){let e=g.querySelector('div[class=""]'),t=document.querySelector(".relative.transition-all.Aside_section__QYARK:not(.px-3)");if(!t)return console.warn("no small side panel");let a=t.querySelector('div[class=""]');if(!e||!a)return console.warn("no recent list");for(let{bsn:r,name:n,src:i}of(f&&f.disconnect(),e.innerHTML="",a.innerHTML="",o)){if(0==d--)break;let l=document.createElement("span"),s=document.createElement("a");s.href="https://forum.gamer.com.tw/B.php?bsn="+r,s.className="baha-duration-300 baha-ease-out baha-select-none baha-cursor-pointer baha-text-sm hover:baha-text-primary baha-text-secondary-text myBoard_boardItem__wyod_",s.tabIndex=-1;let c=document.createElement("img");c.className="myBoard_boardImage__Oa5K_ mr-2",c.alt=n,c.src=i,c.loading="lazy";let p=document.createElement("span");p.className="line-clamp-2 leading-tight",p.innerHTML=n,s.append(c),s.append(p),l.append(s),e.append(l);let m=l.cloneNode(!0),u=m.querySelector("a"),h=u.querySelector("img");h.className="myBoard_boardImage__Oa5K_",c.src=i;let $=u.querySelector("span");$.className="line-clamp-2 leading-tight !hidden",a.append(m)}f.observe(g,{childList:!0,subtree:!0})}let f=new MutationObserver(h);f.observe(g,{childList:!0,subtree:!0}),h()}}());