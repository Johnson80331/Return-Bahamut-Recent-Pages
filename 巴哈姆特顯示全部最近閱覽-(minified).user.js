// ==UserScript==
// @name         巴哈姆特顯示全部最近閱覽
// @namespace    巴哈姆特顯示全部最近閱覽-Johnson8033
// @version      1.7(minified)
// @author       Johnson8033
// @description  在原本位置增加全部最近閱覽
// @match        https://www.gamer.com.tw/*
// @match        https://forum.gamer.com.tw/*
// @icon         https://i2.bahamut.com.tw/favicon.svg?v=1689129528
// @require      https://unpkg.com/@popperjs/core@2
// @require      https://unpkg.com/tippy.js@6
// @grant        GM_registerMenuCommand
// @grant        GM_setValue
// @grant        GM_getValue
// @grant        GM_xmlhttpRequest
// @license      MIT
// @downloadURL  https://github.com/Johnson80331/Return-Bahamut-Recent-Pages/raw/refs/heads/main/%E5%B7%B4%E5%93%88%E5%A7%86%E7%89%B9%E9%A1%AF%E7%A4%BA%E5%85%A8%E9%83%A8%E6%9C%80%E8%BF%91%E9%96%B1%E8%A6%BD-(minified).user.js
// @updateURL    https://github.com/Johnson80331/Return-Bahamut-Recent-Pages/raw/refs/heads/main/%E5%B7%B4%E5%93%88%E5%A7%86%E7%89%B9%E9%A1%AF%E7%A4%BA%E5%85%A8%E9%83%A8%E6%9C%80%E8%BF%91%E9%96%B1%E8%A6%BD-(minified).user.js
// ==/UserScript==

!async function(){"use strict";let e=window.location.href,t=GM_getValue("recentForums",[]);function a(e){let t=document.cookie.split("; ").find(t=>t.startsWith(e+"="));return t?decodeURIComponent(t.split("=")[1]):null}let n=a("ckTheme")?"dark":"light";GM_registerMenuCommand("更改顯示數量",function e(){if(document.getElementById("tm-integer-overlay"))return;let t=GM_getValue("recent",10),a={dark:{overlayBg:"rgba(0,0,0,0.7)",boxBg:"#1e1e1e",textColor:"#fff",inputBg:"#333",inputText:"#fff"},light:{overlayBg:"rgba(0,0,0,0.5)",boxBg:"#fff",textColor:"#000",inputBg:"#fff",inputText:"#000"}}[n],r=document.createElement("div");r.id="tm-integer-overlay",Object.assign(r.style,{position:"fixed",top:"0",left:"0",width:"100%",height:"100%",backgroundColor:a.overlayBg,display:"flex",justifyContent:"center",alignItems:"center",zIndex:"999999",fontFamily:'"Noto Sans TC", "Microsoft JhengHei", "PingFang TC", "Heiti TC", sans-serif'});let o=document.createElement("div");Object.assign(o.style,{backgroundColor:a.boxBg,padding:"20px",borderRadius:"10px",textAlign:"center",minWidth:"250px",boxShadow:"0 0 15px rgba(0,0,0,0.3)",color:a.textColor,display:"flex",flexDirection:"column",gap:"8px"});let i=document.createElement("div");i.textContent="輸入顯示數量(1-30):",i.style.marginBottom="10px";let l=document.createElement("input");l.type="number",l.min="1",l.max="30",l.value=t,l.style.width="100%",l.style.boxSizing="border-box",l.addEventListener("keypress",e=>{let t=String.fromCharCode(e.which);/[0-9]/.test(t)||e.preventDefault()}),l.addEventListener("paste",e=>{let t=(e.clipboardData||window.clipboardData).getData("text");/^\d+$/.test(t)||e.preventDefault()}),Object.assign(l.style,{width:"100%",padding:"8px",marginBottom:"10px",fontSize:"16px",borderRadius:"5px",border:"1px solid #ccc",backgroundColor:a.inputBg,color:a.inputText,outline:"none"});let s=document.createElement("button");s.textContent="確認",Object.assign(s.style,{padding:"8px 16px",fontSize:"16px",borderRadius:"5px",border:"none",backgroundColor:"#11aac1",color:"#fff",cursor:"pointer",alignSelf:"center"}),s.onmouseenter=()=>{s.style.backgroundColor="#117e96"},s.onmouseleave=()=>{s.style.backgroundColor="#11aac1"};let c=document.createElement("div");Object.assign(c.style,{color:"red",marginTop:"5px",fontSize:"14px",height:"18px",textAlign:"center"}),s.onclick=()=>{let e=parseInt(l.value,10);isNaN(e)||e<1||e>30?c.textContent="請輸入1-30的數字":(GM_setValue("recent",e),r.remove())},o.appendChild(i),o.appendChild(l),o.appendChild(s),o.appendChild(c),r.appendChild(o),document.body.appendChild(r)});let r=a("ckBH_lastBoard");if(!r)return console.warn("!ckBH_lastBoard");let o;try{o=JSON.parse(r)}catch(i){console.error(i);return}function l(e,t){return new Promise(a=>{GM_xmlhttpRequest({method:"GET",url:`https://forum.gamer.com.tw/A.php?bsn=${e}`,onload(e){try{let n=new DOMParser,r=n.parseFromString(e.responseText,"text/html"),o=r.querySelector(t);a(o?o.src:"")}catch(i){a("")}},onerror(){a("")}})})}function s(e,t,a){return new Promise(n=>{let r=new Image,o=t+(t.includes("?")?"&":"?")+"_cb="+Date.now();r.onload=()=>{r.naturalWidth>0?n(t):n(l(e,a))},r.onerror=()=>n(l(e,a)),r.src=o})}async function c(e,t){let a=GM_getValue("recentForums",[]),n={bsn:e,name:t},[r,o]=await Promise.all([l(e,"div.FM-abox6B a img"),l(e,"div.FM-abox1.tippy-abox a img")]);n.src=r,n.srcWelcome=o,(a=a.filter(t=>t.bsn!==e)).unshift(n),a.length>30&&(a=a.slice(0,30)),GM_setValue("recentForums",a)}async function d(e,a){(await Promise.all(o.map(async([e,t])=>{let[a,n]=await Promise.all([l(e,"div.FM-abox6B a img"),l(e,"div.FM-abox1.tippy-abox a img")]);return{bsn:e,name:t,src:a,srcWelcome:n}}))).forEach(e=>{(t=t.filter(t=>t.bsn!==e.bsn)).push(e)}),GM_setValue("recentForums",t)}let m=!1;if(0===t.length?await d():o&&!(e.startsWith("https://www.gamer.com.tw/")||"https://forum.gamer.com.tw/"===e||e.startsWith("https://forum.gamer.com.tw/?c="))?await c(o[0][0],o[0][1]):m=!0,!(o=GM_getValue("recentForums",[])))return console.warn("cookies list empty");let p=GM_getValue("recent",null);async function u(){let e=await Promise.all(o.map(async({bsn:e,name:t,src:a="",srcWelcome:n=""})=>{let[r,o]=await Promise.all([a?s(e,a,"div.FM-abox6B a img"):a,n?s(e,n,"div.FM-abox1.tippy-abox a img"):n]);return{bsn:e,name:t,src:r,srcWelcome:o}}));o=[],e.forEach(e=>{(o=o.filter(t=>t.bsn!==e.bsn)).push(e)}),GM_setValue("recentForums",o)}if(p||GM_setValue("recent",p=10),m&&await u(),e.startsWith("https://www.gamer.com.tw/")){function g(){let e=document.querySelector("#boardHistory");if(!e)return console.warn("no boardHistory");for(let{bsn:t,name:a,src:n="",srcWelcome:r=""}of(f&&f.disconnect(),e.innerHTML="",p=GM_getValue("recent",10),o)){if(0==p--)break;let i=document.createElement("li");i.className="sidenav-section__item";let l=document.createElement("a");l.className="sidenav-section__link link-item",l.href="https://forum.gamer.com.tw/B.php?bsn="+t,l.dataset.collapseTippy=a,l.dataset.gtmArea="最近閱覽",l.dataset.gtmLinkClick="點擊哈啦板",l.dataset.gtmPage="新首頁",l.dataset.gtmService="forum",l.dataset.gtmVar1=t;let s=document.createElement("div");s.className="sidenav-section__content";let c=document.createElement("img");c.className="sidenav-section__img",c.src=n||r||"",c.loading="lazy";let d=document.createElement("p");d.className="sidenav-section__name",d.textContent=a,s.appendChild(c),s.appendChild(d),l.appendChild(s),i.appendChild(l),e.appendChild(i)}f.observe(e,{childList:!0,subtree:!0})}let h=document.querySelector("#boardHistory"),f=new MutationObserver(g);f.observe(h,{childList:!0,subtree:!0}),g()}else if("https://forum.gamer.com.tw/"===e||e.startsWith("https://forum.gamer.com.tw/?c=")){let b=document.querySelector(".relative.transition-all.Aside_section__QYARK.px-3");function $(){let e=b.querySelector('div[class=""]'),t=document.querySelector(".relative.transition-all.Aside_section__QYARK:not(.px-3)");if(!t)return console.warn("no small side panel");let a=t.querySelector('div[class=""]');if(!e||!a)return console.warn("no recent list");for(let{bsn:r,name:i,src:l="",srcWelcome:s=""}of(x&&x.disconnect(),e.innerHTML="",a.innerHTML="",p=GM_getValue("recent",10),o)){if(0==p--)break;let c=document.createElement("span"),d=document.createElement("a");d.href="https://forum.gamer.com.tw/B.php?bsn="+r,d.className="baha-duration-300 baha-ease-out baha-select-none baha-cursor-pointer baha-text-sm hover:baha-text-primary baha-text-secondary-text myBoard_boardItem__wyod_",d.tabIndex=-1;let m=document.createElement("img");m.className="myBoard_boardImage__Oa5K_ mr-2",m.alt=i,m.src=s||l||"",m.loading="lazy";let u=document.createElement("span");u.className="line-clamp-2 leading-tight",u.innerHTML=i,d.append(m),d.append(u),c.append(d),e.append(c);let g=c.cloneNode(!0),h=g.querySelector("a"),f=h.querySelector("img");f.className="myBoard_boardImage__Oa5K_";let $=h.querySelector("span");$.className="line-clamp-2 leading-tight !hidden",a.append(g),tippy(g,{content:i,theme:n,placement:"right",animation:"fade",maxWidth:350})}x.observe(b,{childList:!0,subtree:!0})}let x=new MutationObserver($);x.observe(b,{childList:!0,subtree:!0}),$()}}();